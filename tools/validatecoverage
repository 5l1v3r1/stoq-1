#!/usr/bin/env python
import sys

from xml.etree.ElementTree import parse

EXCEPTIONS = {
    'stoq/__init__.py': 0.8571,
    'stoq/daemonmain.py': 0.2973,
    'stoq/dbadmin.py': 0.1331,
    'stoq/main.py': 0.6071,
    'stoq/gui/accounts.py': 0.4552,
    'stoq/gui/admin.py': 0.6119,
    'stoq/gui/application.py': 0.609,
    'stoq/gui/calendar.py': 0.5342,
    'stoq/gui/config.py': 0.6952,
    'stoq/gui/financial.py': 0.5524,
    'stoq/gui/__init__.py': 0,
    'stoq/gui/inventory.py': 0.6497,
    'stoq/gui/launcher.py': 0.8608,
    'stoq/gui/payable.py': 0.7611,
    'stoq/gui/pos.py': 0.6367,
    'stoq/gui/production.py': 0.6667,
    'stoq/gui/purchase.py': 0.5474,
    'stoq/gui/receivable.py': 0.7617,
    'stoq/gui/sales.py': 0.6838,
    'stoq/gui/shell.py': 0.3869,
    'stoq/gui/stock.py': 0.5868,
    'stoq/gui/till.py': 0.5754,
    'stoq/gui/update.py': 0.3152,
    'stoq/gui/welcomedialog.py': 0.3455,
    'stoq/lib/__init__.py': 0,
    'stoq/lib/applist.py': 0.963,
    'stoq/lib/dependencies.py': 0.6008,
    'stoq/lib/gicompat.py': 0.04386,
    'stoq/lib/logging.py': 0.9412,
    'stoq/lib/startup.py': 0.5195,
    'stoqlib/api.py': 0.6889,
    'stoqlib/chart/chart.py': 0.6522,
    'stoqlib/chart/__init__.py': 0,
    'stoqlib/chart/paymentcharts.py': 0.1739,
    'stoqlib/database/admin.py': 0.7799,
    'stoqlib/database/migration.py': 0.5217,
    'stoqlib/database/orm.py': 0.8224,
    'stoqlib/database/runtime.py': 0.7213,
    'stoqlib/database/settings.py': 0.4397,
    'stoqlib/database/tables.py': 0.8696,
    'stoqlib/domain/account.py': 0.9379,
    'stoqlib/domain/address.py': 0.9149,
    'stoqlib/domain/base.py': 0.95,
    'stoqlib/domain/commission.py': 0.9494,
    'stoqlib/domain/devices.py': 0.7945,
    'stoqlib/domain/exampledata.py': 0.9125,
    'stoqlib/domain/fiscal.py': 0.9844,
    'stoqlib/domain/image.py': 0.7143,
    'stoqlib/domain/interfaces.py': 0.9583,
    'stoqlib/domain/inventory.py': 0.9238,
    'stoqlib/domain/loan.py': 0.8165,
    'stoqlib/domain/payment/category.py': 0.9231,
    'stoqlib/domain/payment/comment.py': 0.9286,
    'stoqlib/domain/payment/group.py': 0.8889,
    'stoqlib/domain/payment/__init__.py': 0,
    'stoqlib/domain/payment/method.py': 0.8981,
    'stoqlib/domain/payment/operation.py': 0.7246,
    'stoqlib/domain/payment/payment.py': 0.9242,
    'stoqlib/domain/payment/renegotiation.py': 0.7358,
    'stoqlib/domain/payment/views.py': 0.7425,
    'stoqlib/domain/person.py': 0.8566,
    'stoqlib/domain/plugin.py': 0.8571,
    'stoqlib/domain/production.py': 0.9142,
    'stoqlib/domain/product.py': 0.9179,
    'stoqlib/domain/profile.py': 0.9545,
    'stoqlib/domain/purchase.py': 0.769,
    'stoqlib/domain/receiving.py': 0.7964,
    'stoqlib/domain/returnedsale.py': 0.8797,
    'stoqlib/domain/sale.py': 0.8748,
    'stoqlib/domain/sellable.py': 0.8619,
    'stoqlib/domain/service.py': 0.9348,
    'stoqlib/domain/station.py': 0.9268,
    'stoqlib/domain/stockdecrease.py': 0.8353,
    'stoqlib/domain/system.py': 0.8889,
    'stoqlib/domain/taxes.py': 0.9873,
    'stoqlib/domain/till.py': 0.9915,
    'stoqlib/domain/transfer.py': 0.987,
    'stoqlib/domain/uiform.py': 0.975,
    'stoqlib/domain/views.py': 0.9556,
    'stoqlib/drivers/cheque.py': 0.3846,
    'stoqlib/drivers/scale.py': 0.5,
    'stoqlib/exceptions.py': 0.7941,
    'stoqlib/exporters/__init__.py': 0,
    'stoqlib/exporters/xlsexporter.py': 0.9359,
    'stoqlib/gui/base/columns.py': 0.8182,
    'stoqlib/gui/base/dialogs.py': 0.687,
    'stoqlib/gui/base/__init__.py': 0,
    'stoqlib/gui/base/lists.py': 0.5953,
    'stoqlib/gui/base/messagebar.py': 0.375,
    'stoqlib/gui/base/search.py': 0.7627,
    'stoqlib/gui/base/wizards.py': 0.8722,
    'stoqlib/gui/dialogs/branchdialog.py': 0.9884,
    'stoqlib/gui/dialogs/chartdialog.py': 0.2302,
    'stoqlib/gui/dialogs/crashreportdialog.py': 0.6093,
    'stoqlib/gui/dialogs/devices.py': 0.8947,
    'stoqlib/gui/dialogs/feedbackdialog.py': 0.5,
    'stoqlib/gui/dialogs/importerdialog.py': 0.2361,
    'stoqlib/gui/dialogs/initialstockdialog.py': 0.9091,
    'stoqlib/gui/dialogs/__init__.py': 0,
    'stoqlib/gui/dialogs/loandetails.py': 0.72,
    'stoqlib/gui/dialogs/manufacturerdialog.py': 0.7391,
    'stoqlib/gui/dialogs/openinventorydialog.py': 0.9588,
    'stoqlib/gui/dialogs/paymentcategorydialog.py': 0.5897,
    'stoqlib/gui/dialogs/paymentcommentsdialog.py': 0.7391,
    'stoqlib/gui/dialogs/paymentflowhistorydialog.py': 0.9211,
    'stoqlib/gui/dialogs/paymentmethod.py': 0.871,
    'stoqlib/gui/dialogs/pluginsdialog.py': 0.4,
    'stoqlib/gui/dialogs/productadjustmentdialog.py': 0.8519,
    'stoqlib/gui/dialogs/productcountingdialog.py': 0.4024,
    'stoqlib/gui/dialogs/productiondetails.py': 0.8372,
    'stoqlib/gui/dialogs/productionquotedialog.py': 0.3763,
    'stoqlib/gui/dialogs/progressdialog.py': 0.75,
    'stoqlib/gui/dialogs/purchasedetails.py': 0.7963,
    'stoqlib/gui/dialogs/quotedialog.py': 0.3832,
    'stoqlib/gui/dialogs/receivingdialog.py': 0.5476,
    'stoqlib/gui/dialogs/renegotiationdetails.py': 0.493,
    'stoqlib/gui/dialogs/saledetails.py': 0.9091,
    'stoqlib/gui/dialogs/sellableimage.py': 0.4412,
    'stoqlib/gui/dialogs/sellablepricedialog.py': 0.9907,
    'stoqlib/gui/dialogs/sintegradialog.py': 0.661,
    'stoqlib/gui/dialogs/spreadsheetexporterdialog.py': 0.2545,
    'stoqlib/gui/dialogs/startproduction.py': 0.7,
    'stoqlib/gui/dialogs/stockcostdialog.py': 0.4262,
    'stoqlib/gui/dialogs/stockdecreasedialog.py': 0.72,
    'stoqlib/gui/dialogs/supplierdetails.py': 0.9474,
    'stoqlib/gui/dialogs/tillhistory.py': 0.8571,
    'stoqlib/gui/dialogs/transferorderdialog.py': 0.6364,
    'stoqlib/gui/editors/accounteditor.py': 0.8073,
    'stoqlib/gui/editors/accounttransactioneditor.py': 0.7864,
    'stoqlib/gui/editors/addresseditor.py': 0.8848,
    'stoqlib/gui/editors/baseeditor.py': 0.834,
    'stoqlib/gui/editors/callseditor.py': 0.8085,
    'stoqlib/gui/editors/categoryeditor.py': 0.7067,
    'stoqlib/gui/editors/clientcategoryeditor.py': 0.9167,
    'stoqlib/gui/editors/creditcheckhistoryeditor.py': 0.9697,
    'stoqlib/gui/editors/decreaseeditor.py': 0.9394,
    'stoqlib/gui/editors/deliveryeditor.py': 0.6375,
    'stoqlib/gui/editors/deviceseditor.py': 0.7545,
    'stoqlib/gui/editors/fiscaleditor.py': 0.9412,
    'stoqlib/gui/editors/formfieldeditor.py': 0.8478,
    'stoqlib/gui/editors/__init__.py': 0,
    'stoqlib/gui/editors/invoiceeditor.py': 0.6593,
    'stoqlib/gui/editors/loaneditor.py': 0.8056,
    'stoqlib/gui/editors/parameterseditor.py': 0.9455,
    'stoqlib/gui/editors/paymentcategoryeditor.py': 0.75,
    'stoqlib/gui/editors/paymenteditor.py': 0.8102,
    'stoqlib/gui/editors/paymentmethodeditor.py': 0.8913,
    'stoqlib/gui/editors/paymentseditor.py': 0.8929,
    'stoqlib/gui/editors/personeditor.py': 0.9632,
    'stoqlib/gui/editors/preferenceseditor.py': 0.9315,
    'stoqlib/gui/editors/producteditor.py': 0.7703,
    'stoqlib/gui/editors/productioneditor.py': 0.702,
    'stoqlib/gui/editors/profileeditor.py': 0.9412,
    'stoqlib/gui/editors/purchaseeditor.py': 0.878,
    'stoqlib/gui/editors/receivingeditor.py': 0.8966,
    'stoqlib/gui/editors/saleeditor.py': 0.8243,
    'stoqlib/gui/editors/sellableeditor.py': 0.7227,
    'stoqlib/gui/editors/serviceeditor.py': 0.98,
    'stoqlib/gui/editors/shortcutseditor.py': 0.6889,
    'stoqlib/gui/editors/stationeditor.py': 0.8235,
    'stoqlib/gui/editors/tilleditor.py': 0.7986,
    'stoqlib/gui/fields.py': 0.7419,
    'stoqlib/gui/fiscalprinter.py': 0.5275,
    'stoqlib/gui/search/callsearch.py': 0.9247,
    'stoqlib/gui/search/categorysearch.py': 0.7,
    'stoqlib/gui/search/clientsalaryhistorysearch.py': 0.6364,
    'stoqlib/gui/search/commissionsearch.py': 0.6667,
    'stoqlib/gui/search/consignmentsearch.py': 0.7778,
    'stoqlib/gui/search/creditcheckhistorysearch.py': 0.9808,
    'stoqlib/gui/search/deliverysearch.py': 0.7333,
    'stoqlib/gui/search/eventsearch.py': 0.8824,
    'stoqlib/gui/search/fiscalsearch.py': 0.7935,
    'stoqlib/gui/search/__init__.py': 0,
    'stoqlib/gui/search/loansearch.py': 0.5541,
    'stoqlib/gui/search/parametersearch.py': 0.75,
    'stoqlib/gui/search/paymentsearch.py': 0.6353,
    'stoqlib/gui/search/personsearch.py': 0.5775,
    'stoqlib/gui/search/productionsearch.py': 0.6491,
    'stoqlib/gui/search/productsearch.py': 0.7085,
    'stoqlib/gui/search/profilesearch.py': 0.8,
    'stoqlib/gui/search/purchasesearch.py': 0.6944,
    'stoqlib/gui/search/receivingsearch.py': 0.5882,
    'stoqlib/gui/search/salesearch.py': 0.8264,
    'stoqlib/gui/search/salespersonsearch.py': 0.9355,
    'stoqlib/gui/search/sellablesearch.py': 0.7449,
    'stoqlib/gui/search/sellableunitsearch.py': 0.6923,
    'stoqlib/gui/search/servicesearch.py': 0.5303,
    'stoqlib/gui/search/stationsearch.py': 0.8182,
    'stoqlib/gui/search/stockdecreasesearch.py': 0.5818,
    'stoqlib/gui/search/taxclasssearch.py': 0.5303,
    'stoqlib/gui/search/tillsearch.py': 0.7619,
    'stoqlib/gui/search/transfersearch.py': 0.5614,
    'stoqlib/gui/slaves/branchslave.py': 0.9231,
    'stoqlib/gui/slaves/cashchangeslave.py': 0.8947,
    'stoqlib/gui/slaves/clientslave.py': 0.9333,
    'stoqlib/gui/slaves/commissionslave.py': 0.6056,
    'stoqlib/gui/slaves/credproviderslave.py': 0.8966,
    'stoqlib/gui/slaves/employeeslave.py': 0.8548,
    'stoqlib/gui/slaves/imageslaveslave.py': 0.5469,
    'stoqlib/gui/slaves/__init__.py': 0,
    'stoqlib/gui/slaves/paymentconfirmslave.py': 0.653,
    'stoqlib/gui/slaves/liaisonslave.py': 0.6129,
    'stoqlib/gui/slaves/paymentmethodslave.py': 0.9412,
    'stoqlib/gui/slaves/paymentslave.py': 0.7252,
    'stoqlib/gui/slaves/productionslave.py': 0.8164,
    'stoqlib/gui/slaves/productslave.py': 0.8855,
    'stoqlib/gui/slaves/receivingslave.py': 0.6623,
    'stoqlib/gui/slaves/saleslave.py': 0.5749,
    'stoqlib/gui/slaves/sellableslave.py': 0.8857,
    'stoqlib/gui/slaves/taxslave.py': 0.8486,
    'stoqlib/gui/slaves/userslave.py': 0.7108,
    'stoqlib/gui/stockicons.py': 0.9844,
    'stoqlib/gui/templates/companytemplate.py': 0.8333,
    'stoqlib/gui/templates/individualtemplate.py': 0.8889,
    'stoqlib/gui/templates/__init__.py': 0,
    'stoqlib/gui/templates/persontemplate.py': 0.8941,
    'stoqlib/gui/test/uitestutils.py': 0.9231,
    'stoqlib/gui/utils/aptpackageinstaller.py': 0.3036,
    'stoqlib/gui/utils/databaseform.py': 0.9048,
    'stoqlib/gui/utils/help.py': 0.3704,
    'stoqlib/gui/utils/introspection.py': 0.1765,
    'stoqlib/gui/utils/login.py': 0.224,
    'stoqlib/gui/utils/keybindings.py': 0.701,
    'stoqlib/gui/utils/keyboardhandler.py': 0.4762,
    'stoqlib/gui/utils/openbrowser.py': 0.4286,
    'stoqlib/gui/utils/printing.py': 0.2662,
    'stoqlib/gui/widgets/accounttree.py': 0.8073,
    'stoqlib/gui/widgets/fieldgrid.py': 0.2476,
    'stoqlib/gui/widgets/processview.py': 0.4878,
    'stoqlib/gui/widgets/splash.py': 0.2857,
    'stoqlib/gui/widgets/toolmenuaction.py': 0.9231,
    'stoqlib/gui/widgets/webview.py': 0.3272,
    'stoqlib/gui/wizards/abstractwizard.py': 0.6583,
    'stoqlib/gui/wizards/consignmentwizard.py': 0.3949,
    'stoqlib/gui/wizards/__init__.py': 0,
    'stoqlib/gui/wizards/loanwizard.py': 0.8963,
    'stoqlib/gui/wizards/personwizard.py': 0.3459,
    'stoqlib/gui/wizards/productionwizard.py': 0.8922,
    'stoqlib/gui/wizards/purchasefinishwizard.py': 0.4324,
    'stoqlib/gui/wizards/purchasequotewizard.py': 0.3,
    'stoqlib/gui/wizards/purchasewizard.py': 0.8121,
    'stoqlib/gui/wizards/receivingwizard.py': 0.8242,
    'stoqlib/gui/wizards/renegotiationwizard.py': 0.3367,
    'stoqlib/gui/wizards/salequotewizard.py': 0.5224,
    'stoqlib/gui/wizards/salereturnwizard.py': 0.8756,
    'stoqlib/gui/wizards/salewizard.py': 0.7487,
    'stoqlib/gui/wizards/stockdecreasewizard.py': 0.9048,
    'stoqlib/gui/wizards/stocktransferwizard.py': 0.8396,
    'stoqlib/importers/accounttransactionimporter.py': 0.9444,
    'stoqlib/importers/branchimporter.py': 0.9167,
    'stoqlib/importers/creditproviderimporter.py': 0.5385,
    'stoqlib/importers/csvimporter.py': 0.8154,
    'stoqlib/importers/gnucashimporter.py': 0.2586,
    'stoqlib/importers/importer.py': 0.8167,
    'stoqlib/importers/ofximporter.py': 0.8828,
    'stoqlib/importers/productimporter.py': 0.9024,
    'stoqlib/importers/purchaseimporter.py': 0.9,
    'stoqlib/importers/saleimporter.py': 0.9444,
    'stoqlib/importers/supplierimporter.py': 0.9048,
    'stoqlib/importers/transferimporter.py': 0.871,
    'stoqlib/__init__.py': 0,
    'stoqlib/l10n/br/br.py': 0.9688,
    'stoqlib/l10n/br/__init__.py': 0,
    'stoqlib/l10n/generic/generic.py': 0.9259,
    'stoqlib/l10n/generic/__init__.py': 0,
    'stoqlib/l10n/__init__.py': 0,
    'stoqlib/l10n/l10n.py': 0.8261,
    'stoqlib/l10n/sv/__init__.py': 0,
    'stoqlib/l10n/sv/sv.py': 0.6207,
    'stoqlib/lib/algorithms.py': 0.6854,
    'stoqlib/lib/barcode.py': 0.4828,
    'stoqlib/lib/boleto.py': 0.8238,
    'stoqlib/lib/cardinals/cardinals.py': 0.56,
    'stoqlib/lib/cardinals/generic.py': 0.8857,
    'stoqlib/lib/cardinals/__init__.py': 0,
    'stoqlib/lib/cardinals/pt.py': 0.9533,
    'stoqlib/lib/component.py': 0.4948,
    'stoqlib/lib/configparser.py': 0.2469,
    'stoqlib/lib/console.py': 0.3659,
    'stoqlib/lib/cookie.py': 0.9487,
    'stoqlib/lib/countries.py': 0.9091,
    'stoqlib/lib/crashreport.py': 0.6885,
    'stoqlib/lib/daemonutils.py': 0.4028,
    'stoqlib/lib/dateutils.py': 0.5182,
    'stoqlib/lib/decorators.py': 0.9268,
    'stoqlib/lib/defaults.py': 0.4821,
    'stoqlib/lib/devicemanager.py': 0.4853,
    'stoqlib/lib/diffutils.py': 0.8462,
    'stoqlib/lib/doctestloader.py': 0.7812,
    'stoqlib/lib/formatters.py': 0.8676,
    'stoqlib/lib/interfaces.py': 0.8615,
    'stoqlib/lib/introspection.py': 0.9394,
    'stoqlib/lib/invoice.py': 0.8746,
    'stoqlib/lib/kiwilibrary.py': 0.9565,
    'stoqlib/lib/latscii.py': 0.7647,
    'stoqlib/lib/message.py': 0.5111,
    'stoqlib/lib/osutils.py': 0.3412,
    'stoqlib/lib/parameters.py': 0.803,
    'stoqlib/lib/payment.py': 0.9302,
    'stoqlib/lib/permissions.py': 0.9706,
    'stoqlib/lib/pluginmanager.py': 0.9541,
    'stoqlib/lib/process.py': 0.8182,
    'stoqlib/lib/settings.py': 0.5641,
    'stoqlib/lib/sintegragenerator.py': 0.8253,
    'stoqlib/lib/sintegra.py': 0.886,
    'stoqlib/lib/translation.py': 0.9231,
    'stoqlib/lib/unittestutils.py': 0.7273,
    'stoqlib/lib/uptime.py': 0.8889,
    'stoqlib/lib/validators.py': 0.8857,
    'stoqlib/lib/webservice.py': 0.3554,
    'stoqlib/net/calendarevents.py': 0.162,
    'stoqlib/net/gtk2reactor.py': 0.257,
    'stoqlib/net/__init__.py': 0,
    'stoqlib/net/socketutils.py': 0.25,
    'stoqlib/net/webserver.py': 0.3939,
    'stoqlib/net/xmlrpcservice.py': 0.451,
    'stoqlib/reporting/base/defaultstyle.py': 0.9535,
    'stoqlib/reporting/base/flowables.py': 0.8462,
    'stoqlib/reporting/base/__init__.py': 0,
    'stoqlib/reporting/base/printing.py': 0.925,
    'stoqlib/reporting/base/tables.py': 0.5512,
    'stoqlib/reporting/base/template.py': 0.8088,
    'stoqlib/reporting/base/utils.py': 0.2157,
    'stoqlib/reporting/boleto.py': 0.8014,
    'stoqlib/reporting/booklet.py': 0.9231,
    'stoqlib/reporting/inventory.py': 0.7333,
    'stoqlib/reporting/loanreceipt.py': 0.2647,
    'stoqlib/reporting/payment.py': 0.5522,
    'stoqlib/reporting/paymentsreceipt.py': 0.8659,
    'stoqlib/reporting/production.py': 0.8485,
    'stoqlib/reporting/product.py': 0.6364,
    'stoqlib/reporting/purchase.py': 0.4176,
    'stoqlib/reporting/purchasereceival.py': 0.625,
    'stoqlib/reporting/report.py': 0.8387,
    'stoqlib/reporting/sale.py': 0.6564,
    'stoqlib/reporting/service.py': 0.7273,
    'stoqlib/reporting/stockdecreasereceipt.py': 0.375,
    'stoqlib/reporting/template.py': 0.8615,
}

_errors = []

def _error(msg):
    _errors.append(msg)

tool = "tools/validatecoverage"

root = parse(open("coverage.xml"))

modules = {}

for module in sorted(root.findall('.//class')):
    filename = module.attrib['filename']
    modules[filename] = module
    expect = EXCEPTIONS.get(filename, 1)
    current = float(module.attrib.get('line-rate'))
    if current == 1 and expect < 1:
        _error("%s reached 100%%, remove it from %s" % (
            filename, tool))
        continue
    if expect == 1 and current < 1:
        _error("%s has a coverage of %s%%, but expected %s%%, "
               "add more tests or update %s" % (
            filename, current * 100, expect * 100, tool))
        continue

for filename in EXCEPTIONS:
    if not filename in modules:
        _error("%s not found, remove it from %s" % (
            filename, tool))
        continue

for error in _errors:
    print 'ERROR:', error

sys.exit(0)
