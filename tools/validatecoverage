#!/usr/bin/env python
from collections import OrderedDict
import sys

from xml.etree.ElementTree import parse

# This is a list of files that doesn't have 100% coverage
#
# You will need to update this list when:
# - a new file was added without 100% coverage
# - new lines where added that weren't tested
# - 100% test coverage was reached for some file
# - a file got remove/renamed

EXCEPTIONS = OrderedDict((
    ('plugins/books/booksdomain.py', 79.22),
    ('plugins/books/booksplugin.py', 73.08),
    ('plugins/books/bookssearch.py', 41.67),
    ('plugins/books/booksslave.py', 52.50),
    ('plugins/books/booksui.py', 36.99),
    ('plugins/books/publishersearch.py', 68.57),
    ('plugins/ecf/cat52.py', 83.19),
    ('plugins/ecf/catgenerator.py', 29.46),
    ('plugins/ecf/couponprinter.py', 53.25),
    ('plugins/ecf/deviceconstanteditor.py', 40.57),
    ('plugins/ecf/ecfdomain.py', 80.14),
    ('plugins/ecf/ecfmemorydialog.py', 43.14),
    ('plugins/ecf/ecfplugin.py', 76.00),
    ('plugins/ecf/ecfprinterdialog.py', 30.73),
    ('plugins/ecf/ecfprinterstatus.py', 31.88),
    ('plugins/ecf/ecfui.py', 21.88),
    ('plugins/ecf/paulistainvoicedialog.py', 92.00),
    ('plugins/nfe/nfegenerator.py', 74.10),
    ('plugins/nfe/nfeplugin.py', 83.33),
    ('plugins/nfe/nfeui.py', 41.00),
    ('stoq/dbadmin.py', 13.31),
    ('stoq/gui/accounts.py', 0.4552),
    ('stoq/gui/admin.py', 61.19),
    ('stoq/gui/calendar.py', 51),
    ('stoq/gui/config.py', 66.82),
    ('stoq/gui/financial.py', 55.24),
    ('stoq/gui/inventory.py', 64.97),
    ('stoq/gui/launcher.py', 86.08),
    ('stoq/gui/payable.py', 76.11),
    ('stoq/gui/pos.py', 63.67),
    ('stoq/gui/production.py', 66.67),
    ('stoq/gui/purchase.py', 54.74),
    ('stoq/gui/receivable.py', 76.17),
    ('stoq/gui/sales.py', 68.38),
    ('stoq/gui/services.py', 52.08),
    ('stoq/gui/shell/bootstrap.py', 64.36),
    ('stoq/gui/shell/shell.py', 15.48),
    ('stoq/gui/shell/shellapp.py', 80.54),
    ('stoq/gui/shell/shellwindow.py', 61.00),
    ('stoq/gui/shell/statusbar.py', 92.19),
    ('stoq/gui/stock.py', 58.68),
    ('stoq/gui/till.py', 57.54),
    ('stoq/gui/update.py', 31.52),
    ('stoq/gui/welcomedialog.py', 32.73),
    ('stoq/lib/applist.py', 96.30),
    ('stoq/lib/dependencies.py', 60.08),
    ('stoq/lib/generictreemodel.py', 38.71),
    ('stoq/lib/gicompat.py', 04.386),
    ('stoq/lib/startup.py', 51.95),
    ('stoqlib/api.py', 76.53),
    ('stoqlib/database/admin.py', 22),
    ('stoqlib/database/debug.py', 19.05),
    ('stoqlib/database/migration.py', 44),
    ('stoqlib/database/orm.py', 77.27),
    ('stoqlib/database/queryexecuter.py', 89),
    ('stoqlib/database/runtime.py', 72.13),
    ('stoqlib/database/settings.py', 38),
    ('stoqlib/database/tables.py', 86.96),
    ('stoqlib/drivers/cheque.py', 38.46),
    ('stoqlib/drivers/scale.py', 50),
    ('stoqlib/exceptions.py', 79.41),
    ('stoqlib/exporters/xlsexporter.py', 93.59),
    ('stoqlib/gui/base/columns.py', 81.82),
    ('stoqlib/gui/base/dialogs.py', 68.7),
    ('stoqlib/gui/base/lists.py', 59.53),
    ('stoqlib/gui/base/messagebar.py', 37.5),
    ('stoqlib/gui/base/wizards.py', 87.22),
    ('stoqlib/gui/dialogs/batchselectiondialog.py', 71.25),
    ('stoqlib/gui/dialogs/branchdialog.py', 98.84),
    ('stoqlib/gui/dialogs/clientdetails.py', 96.30),
    ('stoqlib/gui/dialogs/contactsdialog.py', 58.62),
    ('stoqlib/gui/dialogs/costcenterdialog.py', 98.51),
    ('stoqlib/gui/dialogs/crashreportdialog.py', 60.93),
    ('stoqlib/gui/dialogs/credentialsdialog.py', 65.38),
    ('stoqlib/gui/dialogs/creditdialog.py', 62.86),
    ('stoqlib/gui/dialogs/devices.py', 89.47),
    ('stoqlib/gui/dialogs/feedbackdialog.py', 50),
    ('stoqlib/gui/dialogs/financialreportdialog.py', 84.62),
    ('stoqlib/gui/dialogs/importerdialog.py', 23.61),
    ('stoqlib/gui/dialogs/initialstockdialog.py', 82),
    ('stoqlib/gui/dialogs/invoicedialog.py', 94.44),
    ('stoqlib/gui/dialogs/labeldialog.py', 96.77),
    ('stoqlib/gui/dialogs/manufacturerdialog.py', 73.91),
    ('stoqlib/gui/dialogs/missingitemsdialog.py', 96.15),
    ('stoqlib/gui/dialogs/paymentcategorydialog.py', 58.97),
    ('stoqlib/gui/dialogs/paymentcommentsdialog.py', 73.91),
    ('stoqlib/gui/dialogs/paymentdetails.py', 51.22),
    ('stoqlib/gui/dialogs/paymentflowhistorydialog.py', 92.11),
    ('stoqlib/gui/dialogs/paymentmethod.py', 87.1),
    ('stoqlib/gui/dialogs/personmergedialog.py', 91.3),
    ('stoqlib/gui/dialogs/pluginsdialog.py', 40),
    ('stoqlib/gui/dialogs/productiondetails.py', 83.72),
    ('stoqlib/gui/dialogs/productionquotedialog.py', 37.63),
    ('stoqlib/gui/dialogs/progressbardialog.py', 71.62),
    ('stoqlib/gui/dialogs/progressdialog.py', 75.),
    ('stoqlib/gui/dialogs/purchasedetails.py', 79.63),
    ('stoqlib/gui/dialogs/quotedialog.py', 38.32),
    ('stoqlib/gui/dialogs/renegotiationdetails.py', 49.3),
    ('stoqlib/gui/dialogs/saledetails.py', 63),
    ('stoqlib/gui/dialogs/sellabledialog.py', 57.58),
    ('stoqlib/gui/dialogs/sellableimage.py', 42),
    ('stoqlib/gui/dialogs/sintegradialog.py', 66.1),
    ('stoqlib/gui/dialogs/spreadsheetexporterdialog.py', 25.45),
    ('stoqlib/gui/dialogs/startproduction.py', 70),
    ('stoqlib/gui/dialogs/stockcostdialog.py', 42.62),
    ('stoqlib/gui/dialogs/supplierdetails.py', 94.74),
    ('stoqlib/gui/dialogs/tillhistory.py', 85.71),
    ('stoqlib/gui/dialogs/workordercategorydialog.py', 85.71),
    ('stoqlib/gui/editors/accounteditor.py', 80.73),
    ('stoqlib/gui/editors/accounttransactioneditor.py', 78.64),
    ('stoqlib/gui/editors/addresseditor.py', 88.48),
    ('stoqlib/gui/editors/baseeditor.py', 83.4),
    ('stoqlib/gui/editors/callseditor.py', 80.85),
    ('stoqlib/gui/editors/categoryeditor.py', 70.67),
    ('stoqlib/gui/editors/clientcategoryeditor.py', 91.67),
    ('stoqlib/gui/editors/creditcheckhistoryeditor.py', 96.97),
    ('stoqlib/gui/editors/deliveryeditor.py', 63.75),
    ('stoqlib/gui/editors/deviceseditor.py', 75.45),
    ('stoqlib/gui/editors/discounteditor.py', 80.00),
    ('stoqlib/gui/editors/fiscaleditor.py', 94.12),
    ('stoqlib/gui/editors/formfieldeditor.py', 84.78),
    ('stoqlib/gui/editors/inventoryadjustmenteditor.py', 85.19),
    ('stoqlib/gui/editors/inventoryeditor.py', 92.31),
    ('stoqlib/gui/editors/invoiceeditor.py', 60),
    ('stoqlib/gui/editors/loanitemeditor.py', 80.39),
    ('stoqlib/gui/editors/noteeditor.py', 92.50),
    ('stoqlib/gui/editors/parameterseditor.py', 94.55),
    ('stoqlib/gui/editors/paymentcategoryeditor.py', 75.),
    ('stoqlib/gui/editors/paymenteditor.py', 81.02),
    ('stoqlib/gui/editors/paymentmethodeditor.py', 89.13),
    ('stoqlib/gui/editors/personeditor.py', 96.32),
    ('stoqlib/gui/editors/preferenceseditor.py', 93.15),
    ('stoqlib/gui/editors/producteditor.py', 77.03),
    ('stoqlib/gui/editors/productioneditor.py', 70.2),
    ('stoqlib/gui/editors/profileeditor.py', 94.12),
    ('stoqlib/gui/editors/purchaseeditor.py', 87.8),
    ('stoqlib/gui/editors/saleeditor.py', 88),
    ('stoqlib/gui/editors/sellableeditor.py', 72.27),
    ('stoqlib/gui/editors/serviceeditor.py', 98.),
    ('stoqlib/gui/editors/shortcutseditor.py', 68.89),
    ('stoqlib/gui/editors/stationeditor.py', 82.35),
    ('stoqlib/gui/editors/taxclasseditor.py', 46.51),
    ('stoqlib/gui/editors/tilleditor.py', 79.86),
    ('stoqlib/gui/editors/workordercategoryeditor.py', 66.67),
    ('stoqlib/gui/editors/workordereditor.py', 78.74),
    ('stoqlib/gui/fields.py', 71),
    ('stoqlib/gui/fiscalprinter.py', 52.75),
    ('stoqlib/gui/interfaces.py', 88.89),
    ('stoqlib/gui/search/callsearch.py', 90.59),
    ('stoqlib/gui/search/categorysearch.py', 70),
    ('stoqlib/gui/search/commissionsearch.py', 66.67),
    ('stoqlib/gui/search/costcentersearch.py', 92.59),
    ('stoqlib/gui/search/creditcheckhistorysearch.py', 98.08),
    ('stoqlib/gui/search/deliverysearch.py', 73.33),
    ('stoqlib/gui/search/eventsearch.py', 85),
    ('stoqlib/gui/search/fiscalsearch.py', 79.35),
    ('stoqlib/gui/search/loansearch.py', 55.41),
    ('stoqlib/gui/search/parametersearch.py', 75.),
    ('stoqlib/gui/search/paymentreceivingsearch.py', 92.21),
    ('stoqlib/gui/search/paymentsearch.py', 63.53),
    ('stoqlib/gui/search/personsearch.py', 57.75),
    ('stoqlib/gui/search/productionsearch.py', 64.91),
    ('stoqlib/gui/search/productsearch.py', 70.85),
    ('stoqlib/gui/search/purchasesearch.py', 69.44),
    ('stoqlib/gui/search/receivingsearch.py', 58.82),
    ('stoqlib/gui/search/returnedsalesearch.py', 80.95),
    ('stoqlib/gui/search/salesearch.py', 82.64),
    ('stoqlib/gui/search/searchcolumns.py', 91.89),
    ('stoqlib/gui/search/searchdialog.py', 86.25),
    ('stoqlib/gui/search/searcheditor.py', 82.52),
    ('stoqlib/gui/search/searchfilters.py', 80.47),
    ('stoqlib/gui/search/searchoptions.py', 94.78),
    ('stoqlib/gui/search/searchresultview.py', 89.36),
    ('stoqlib/gui/search/searchslave.py', 86.77),
    ('stoqlib/gui/search/sellablesearch.py', 74.49),
    ('stoqlib/gui/search/sellableunitsearch.py', 69.23),
    ('stoqlib/gui/search/servicesearch.py', 53.03),
    ('stoqlib/gui/slaves/addressslave.py', 85.14),
    ('stoqlib/gui/slaves/branchslave.py', 92.31),
    ('stoqlib/gui/slaves/cashchangeslave.py', 89.47),
    ('stoqlib/gui/slaves/clientslave.py', 93.33),
    ('stoqlib/gui/slaves/commissionslave.py', 60.56),
    ('stoqlib/gui/slaves/employeeslave.py', 85.48),
    ('stoqlib/gui/slaves/imageslaveslave.py', 54.69),
    ('stoqlib/gui/slaves/paymentconfirmslave.py', 65.3),
    ('stoqlib/gui/slaves/paymentslave.py', 72.52),
    ('stoqlib/gui/slaves/productionslave.py', 76),
    ('stoqlib/gui/slaves/productslave.py', 73),
    ('stoqlib/gui/slaves/receivingslave.py', 66.23),
    ('stoqlib/gui/slaves/saleslave.py', 57.49),
    ('stoqlib/gui/slaves/sellableslave.py', 80),
    ('stoqlib/gui/slaves/taxslave.py', 81.48),
    ('stoqlib/gui/slaves/tillslave.py', 96.15),
    ('stoqlib/gui/slaves/userslave.py', 71.08),
    ('stoqlib/gui/slaves/workorderslave.py', 83.82),
    ('stoqlib/gui/stockicons.py', 98.44),
    ('stoqlib/gui/templates/companytemplate.py', 83.33),
    ('stoqlib/gui/templates/individualtemplate.py', 88.89),
    ('stoqlib/gui/templates/persontemplate.py', 89.41),
    ('stoqlib/gui/utils/databaseform.py', 90.48),
    ('stoqlib/gui/utils/help.py', 31.25),
    ('stoqlib/gui/utils/idle.py', 25.00),
    ('stoqlib/gui/utils/introspection.py', 17.65),
    ('stoqlib/gui/utils/keybindings.py', 70.1),
    ('stoqlib/gui/utils/keyboardhandler.py', 47.62),
    ('stoqlib/gui/utils/login.py', 22.4),
    ('stoqlib/gui/utils/openbrowser.py', 42.86),
    ('stoqlib/gui/utils/printing.py', 26.62),
    ('stoqlib/gui/utils/workorderutils.py', 81.82),
    ('stoqlib/gui/widgets/accounttree.py', 80.73),
    ('stoqlib/gui/widgets/calculator.py', 92),
    ('stoqlib/gui/widgets/fieldgrid.py', 24.76),
    ('stoqlib/gui/widgets/hintedentry.py', 81.82),
    ('stoqlib/gui/widgets/kanbanview.py', 22.41),
    ('stoqlib/gui/widgets/lazyobjectlist.py', 62.56),
    ('stoqlib/gui/widgets/processview.py', 48.78),
    ('stoqlib/gui/widgets/queryentry.py', 66),
    ('stoqlib/gui/widgets/searchentry.py', 90),
    ('stoqlib/gui/widgets/searchfilterbutton.py', 86.67),
    ('stoqlib/gui/widgets/splash.py', 28.57),
    ('stoqlib/gui/widgets/toolmenuaction.py', 89.29),
    ('stoqlib/gui/widgets/webview.py', 32.72),
    ('stoqlib/gui/wizards/abstractwizard.py', 65.83),
    ('stoqlib/gui/wizards/inventorywizard.py', 29.57),
    ('stoqlib/gui/wizards/loanwizard.py', 87),
    ('stoqlib/gui/wizards/personwizard.py', 34.59),
    ('stoqlib/gui/wizards/productionwizard.py', 89.22),
    ('stoqlib/gui/wizards/productwizard.py', 44.23),
    ('stoqlib/gui/wizards/purchasefinishwizard.py', 43.24),
    ('stoqlib/gui/wizards/purchasequotewizard.py', 30),
    ('stoqlib/gui/wizards/purchasewizard.py', 81.21),
    ('stoqlib/gui/wizards/receivingwizard.py', 79),
    ('stoqlib/gui/wizards/renegotiationwizard.py', 33.67),
    ('stoqlib/gui/wizards/salequotewizard.py', 52.24),
    ('stoqlib/gui/wizards/salereturnwizard.py', 87.56),
    ('stoqlib/gui/wizards/salewizard.py', 69.81),
    ('stoqlib/gui/wizards/stockdecreasewizard.py', 90.48),
    ('stoqlib/gui/wizards/stocktransferwizard.py', 83.96),
    ('stoqlib/gui/wizards/workorderpackagewizard.py', 91.18),
    ('stoqlib/gui/wizards/workorderquotewizard.py', 95.38),
    ('stoqlib/importers/accounttransactionimporter.py', 44.44),
    ('stoqlib/importers/branchimporter.py', 36),
    ('stoqlib/importers/creditproviderimporter.py', 53.85),
    ('stoqlib/importers/csvimporter.py', 33),
    ('stoqlib/importers/gnucashimporter.py', 25.86),
    ('stoqlib/importers/importer.py', 72),
    ('stoqlib/importers/ofximporter.py', 88.28),
    ('stoqlib/importers/productimporter.py', 21),
    ('stoqlib/importers/purchaseimporter.py', 29),
    ('stoqlib/importers/saleimporter.py', 34),
    ('stoqlib/importers/supplierimporter.py', 41),
    ('stoqlib/importers/transferimporter.py', 23),
    ('stoqlib/l10n/br/br.py', 96.88),
    ('stoqlib/l10n/generic/generic.py', 92.59),
    ('stoqlib/l10n/l10n.py', 82.61),
    ('stoqlib/l10n/sv/sv.py', 62.07),
    ('stoqlib/lib/algorithms.py', 68.54),
    ('stoqlib/lib/autoreload.py', 69.23),
    ('stoqlib/lib/barcode.py', 48.28),
    ('stoqlib/lib/boleto.py', 82.38),
    ('stoqlib/lib/cardinals/cardinals.py', 56.),
    ('stoqlib/lib/cardinals/generic.py', 88.57),
    ('stoqlib/lib/cardinals/pt.py', 95.33),
    ('stoqlib/lib/configparser.py', 24.69),
    ('stoqlib/lib/console.py', 36.59),
    ('stoqlib/lib/cookie.py', 94.87),
    ('stoqlib/lib/countries.py', 90.91),
    ('stoqlib/lib/crashreport.py', 66.15),
    ('stoqlib/lib/daemonutils.py', 40.28),
    ('stoqlib/lib/dateutils.py', 51.82),
    ('stoqlib/lib/decorators.py', 92.68),
    ('stoqlib/lib/defaults.py', 48.21),
    ('stoqlib/lib/devicemanager.py', 48.53),
    ('stoqlib/lib/diffutils.py', 84.62),
    ('stoqlib/lib/distutils.py', 91.67),
    ('stoqlib/lib/environment.py', 85.71),
    ('stoqlib/lib/formatters.py', 86.76),
    ('stoqlib/lib/interfaces.py', 86.15),
    ('stoqlib/lib/introspection.py', 93.94),
    ('stoqlib/lib/invoice.py', 87.46),
    ('stoqlib/lib/kiwilibrary.py', 90),
    ('stoqlib/lib/latscii.py', 76.47),
    ('stoqlib/lib/message.py', 47),
    ('stoqlib/lib/osutils.py', 34.12),
    ('stoqlib/lib/parameters.py', 54),
    ('stoqlib/lib/payment.py', 91),
    ('stoqlib/lib/permissions.py', 97.06),
    ('stoqlib/lib/pgpass.py', 82.14),
    ('stoqlib/lib/pluginmanager.py', 95.41),
    ('stoqlib/lib/process.py', 37),
    ('stoqlib/lib/settings.py', 56.41),
    ('stoqlib/lib/sintegra.py', 88.6),
    ('stoqlib/lib/sintegragenerator.py', 82.53),
    ('stoqlib/lib/threadutils.py', 29.41),
    ('stoqlib/lib/translation.py', 85),
    ('stoqlib/lib/unittestutils.py', 72.73),
    ('stoqlib/lib/uptime.py', 88.89),
    ('stoqlib/lib/validators.py', 88.57),
    ('stoqlib/lib/webservice.py', 33.54),
    ('stoqlib/migration/domainv1.py', 43),
    ('stoqlib/migration/domainv2.py', 42),
    ('stoqlib/migration/domainv3.py', 39),
    ('stoqlib/migration/domainv4.py', 43),
    ('stoqlib/migration/parameter.py', 27.27),
    ('stoqlib/net/calendarevents.py', 16.2),
    ('stoqlib/net/gtk2reactor.py', 25.7),
    ('stoqlib/net/server.py', 22),
    ('stoqlib/net/socketutils.py', 25.),
    ('stoqlib/net/webserver.py', 39.39),
    ('stoqlib/net/xmlrpcservice.py', 45.1),
    ('stoqlib/reporting/boleto.py', 80.14),
    ('stoqlib/reporting/booklet.py', 92.31),
    ('stoqlib/reporting/clientcredit.py', 93.75),
    ('stoqlib/reporting/financial.py', 90.71),
    ('stoqlib/reporting/labelreport.py', 35.29),
    ('stoqlib/reporting/loanreceipt.py', 26.47),
    ('stoqlib/reporting/payment.py', 55.22),
    ('stoqlib/reporting/paymentsreceipt.py', 86.59),
    ('stoqlib/reporting/product.py', 63.64),
    ('stoqlib/reporting/purchase.py', 41.76),
    ('stoqlib/reporting/report.py', 83.87),
    ('stoqlib/reporting/sale.py', 65.64),
    ('stoqlib/reporting/stockdecrease.py', 37.5),
))

# Make sure that the list of exceptions is sorted
for a, b in zip(EXCEPTIONS, sorted(EXCEPTIONS)):
    if a != b:
        raise AssertionError("keep EXCEPTIONS sorted")

_errors = []


def _error(msg):
    _errors.append(msg)

tool = "tools/validatecoverage"

root = parse(open(sys.argv[1]))
fixes = []
modules = {}

for module in sorted(root.findall('.//class')):
    filename = module.attrib['filename']
    if filename.endswith('__init__.py'):
        continue
    modules[filename] = module
    current = float(module.attrib.get('line-rate')) * 100
    if current != 100 and filename not in EXCEPTIONS:
        _error("2: %s has a coverage of %s%%, but expected 100%%, "
               "add it to %s:" % (filename, current, tool))
        fixes.append("    '%s': %.2f," % (filename, current))
        continue

    expect = EXCEPTIONS.get(filename, 100)
    if current == 100 and expect == 100:
        continue

    if int(current + 1) < int(expect):
        _error("1: %s has a coverage of %s%%, but expected %s%%, "
               "add more tests or update %s" % (filename, current, expect,
                                                tool))
        continue
    if current == 100 and expect < 100:
        _error("3: %s reached 100%%, remove it from %s" % (
            filename, tool))
        continue

for filename in EXCEPTIONS:
    if not filename in modules:
        _error("4: %s not found, remove it from %s" % (
            filename, tool))
        continue

for error in sorted(_errors):
    print 'ERROR:', error

if fixes:
    print "FIXES:"
    for fix in sorted(fixes):
        print fix

sys.exit(len(_errors))
